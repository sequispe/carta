<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sequispe</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">

  <style>
   body {
  font-family: 'Poppins', sans-serif;
  background: url("img/Fondo2.jpg") repeat;
  background-size: cover;
  margin: 0;
  padding: 0;
  color: #45270a;
  text-align: center;
  scroll-behavior: smooth;<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Carta -quispe (Sincroniza precios ES/EN/PT)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
    h1{text-align:center;color:#806250;margin-bottom:10px}
    .topRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="password"], textarea{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box}
    button{background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#5c8a50}
    button.danger{background:#c0392b}
    form{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:none}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#806250;color:#fff}
    img.mini{max-width:60px;border-radius:6px}
    #guardarTodos{position:fixed;top:18px;right:18px;z-index:1200;padding:10px 14px;background:#a07b68;color:#fff;border-radius:8px}
    .small{font-size:13px;color:#666}
    .rowActions{display:flex;gap:6px}
    .previewImg{max-width:120px;margin-top:8px;border-radius:6px}
    textarea#multiInput{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
    .toast {
      position: fixed; top: 24px; right: 24px; z-index: 2000; padding: 12px 16px;
      border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      opacity: 0; transform: translateY(-10px); transition: opacity .25s ease, transform .25s ease; max-width: 360px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.ok { background: #2ecc71; }
    .toast.info { background: #3498db; }
    .toast.err { background: #e74c3c; }
    @media(max-width:720px){ .topRow{flex-direction:column;align-items:flex-start} table{font-size:13px} }
  </style>
</head>
<body>
  <h1>Admin Carta ‚Äî quiepe</h1>
  <div class="topRow">
    <div style="flex:1">
      <div style="margin-bottom:6px"><span class="small">Repositorio:</span> <b> sequispe / carta</b></div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="min-width:40px">Token:</label>
        <input type="password" id="token" placeholder="Pegar token de GitHub (repo contents)" style="max-width:340px">
        <button onclick="saveToken()">Guardar</button>
        <button onclick="clearToken()">Borrar</button>
        <button style="background:#888;padding:6px 8px;border-radius:6px;margin-left:6px" onclick="toggleTokenVisibility()">üëÅ</button>
        <span class="small" id="tokenStatus" style="margin-left:8px">No guardado</span>
      </div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Buscar..." oninput="filterProducts()" style="min-width:180px;max-width:360px">
      <button id="toggleFormBtn" onclick="toggleForm()">+ Agregar producto</button>
      <button class="secondary" onclick="irWhatsApp()">üì≤ Ayuda por WhatsApp</button>
    </div>
  </div>

  <button id="guardarTodos" onclick="guardarTodosLosPrecios()">üíæ Guardar TODOS los cambios</button>

  <!-- Formulario simple -->
  <form id="form">
    <input type="hidden" id="editId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Nombre</label>
        <input id="nombre" type="text">
      </div>
      <div>
        <label>Precio</label>
        <input id="precio" type="text" placeholder="Ej: 3400 (sin $)">
      </div>

      <div style="grid-column:1/3">
        <label>Descripci√≥n</label>
        <textarea id="descripcion" rows="3"></textarea>
      </div>

      <div>
        <label>Imagen (ruta o URL)</label>
        <input id="imagen" type="text" oninput="previewImage()">
        <img id="preview" class="previewImg" style="display:none">
      </div>

      <div>
        <label>Categor√≠a</label>
        <input id="categoria" type="text" placeholder="Ej: Cafeter√≠a">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button type="button" onclick="guardarFormulario()">Guardar</button>
      <button type="button" onclick="cancelForm()" style="background:#999">Cancelar</button>
    </div>
  </form>

  <table aria-label="Productos">
    <thead>
      <tr><th style="width:80px">Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th style="width:100px">Precio (ES)</th><th style="width:180px">Acciones</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
/**********************************************************
 * Config + estado
 **********************************************************/
const USERNAME = "sesquispe";
const REPO = "carta";
const BRANCH = "main";
const MAIN_JSON = "productos.json";
const EN_JSON = "productos-en.json";
const PT_JSON = "productos-port.json";
let productos = []; // esta es la fuente de verdad
let filteredIds = null; // si hay filtro, guardamos ids ordenados para acciones por fila

/**********************************************************
 * Toast
 **********************************************************/
function showToast(msg, variant = 'ok', timeout = 3000){
  const div = document.createElement('div');
  div.className = 'toast ' + (variant === 'info' ? 'info' : variant === 'err' ? 'err' : 'ok');
  div.innerText = (variant === 'err' ? '‚úñÔ∏é ' : variant === 'info' ? '‚ÑπÔ∏é ' : '‚úîÔ∏é ') + msg;
  document.body.appendChild(div);
  requestAnimationFrame(() => div.classList.add('show'));
  setTimeout(() => { div.classList.remove('show'); setTimeout(()=> div.remove(), 300); }, timeout);
}

/**********************************************************
 * Token (guardado en localStorage, bot√≥n de ver/ocultar)
 **********************************************************/
function saveToken(){ const t = document.getElementById('token').value.trim(); if(!t){ showToast('Peg√° tu token primero', 'err'); return; } localStorage.setItem('github_token', t); document.getElementById('tokenStatus').innerText = 'Token guardado'; showToast('Token guardado', 'ok', 1800); }
function clearToken(){ localStorage.removeItem('github_token'); document.getElementById('token').value = ''; document.getElementById('tokenStatus').innerText = 'Token borrado'; showToast('Token borrado', 'info', 1500); }
function getToken(){ return localStorage.getItem('github_token'); }
function toggleTokenVisibility(){ const inp = document.getElementById('token'); inp.type = inp.type === 'password' ? 'text' : 'password'; }
(function initTokenStatus(){ const t = getToken(); if(t){ document.getElementById('tokenStatus').innerText = 'Token guardado'; document.getElementById('token').value = t; /* opcional: mostrar token en input */ } })();

/**********************************************************
 * IDs y util
 **********************************************************/
function extractNumberFromProdId(id){ if(!id) return null; const m = String(id).match(/(\d+)\s*$/); if(m) return parseInt(m[1],10); return null; }
function generateNextProdId(){ let max = 0; for(const p of productos){ const n = extractNumberFromProdId(p.id || ''); if(Number.isFinite(n) && n > max) max = n; } const next = max + 1; return 'prod' + String(next).padStart(4, '0'); }
function sanitizePrice(v){ if(v===undefined||v===null) return ''; const only = String(v).replace(/[^\d]/g,''); return only || ''; }

/**********************************************************
 * Ordenar campos por idioma (ES id al final, EN id primero, PT id al final)
 **********************************************************/
function ordenarCamposPorIdioma(item, idioma){
  const id = item.id || '';
  if(idioma === 'EN'){
    return { id: id, name: item.name || item.nombre || item.nome || '', description: item.description || item.descripcion || item.descricao || '', price: item.price || item.precio || item.preco || '', image: item.image || item.imagen || item.imagem || '', category: item.category || item.categoria || '' };
  }
  if(idioma === 'PT'){
    return { nome: item.nome || item.name || item.nombre || '', descricao: item.descricao || item.description || item.descripcion || '', preco: item.preco || item.price || item.precio || '', imagem: item.imagem || item.image || item.imagen || '', categoria: item.categoria || item.category || '', id: id };
  }
  return { nombre: item.nombre || item.name || item.nome || '', descripcion: item.descripcion || item.description || item.descricao || '', precio: item.precio || item.price || item.preco || '', imagen: item.imagen || item.image || item.imagem || '', categoria: item.categoria || item.category || '', id: id };
}

/**********************************************************
 * Cargar productos.json (desde raw.githubusercontent)
 **********************************************************/
async function loadProducts(){
  try{
    const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}`);
    if(!r.ok) throw new Error(`No se pudo cargar ${MAIN_JSON} (${r.status})`);
    const arr = await r.json();
    if(!Array.isArray(arr)) throw new Error('Formato inv√°lido en productos.json');

    productos = arr.map(item => ({
      id: item.id || '',
      nombre: item.nombre || item.name || item.nome || '',
      descripcion: item.descripcion || item.description || item.descricao || '',
      precio: String(item.precio || item.price || item.preco || ''),
      imagen: item.imagen || item.image || item.imagem || '',
      categoria: item.categoria || item.category || ''
    }));

    let changed = false;
    productos.forEach(p => { if(!p.id || !/^prod\d{4}$/.test(p.id)){ p.id = generateNextProdId(); changed = true; } });
    render(productos);
    if(changed) showToast('Se asignaron IDs faltantes (prodXXXX)', 'info', 2500);

  }catch(e){
    console.warn(e);
    productos = [];
    render(productos);
    showToast("No se pudo cargar productos.json", 'err', 5000);
  }
}

/**********************************************************
 * Render tabla (usar data-id por fila para evitar confundir √≠ndices)
 **********************************************************/
function render(lista){
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';

  // cuando se renderiza, guardamos la lista de ids visibles (para acciones desde la fila)
  filteredIds = lista.map(p => p.id);

  lista.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.dataset.rowId = p.id || '';

    // imagen
    const tdImg = document.createElement('td');
    const img = document.createElement('img');
    img.className = 'mini';
    img.src = p.imagen || '';
    img.onerror = () => { img.style.display='none'; };
    tdImg.appendChild(img);
    tr.appendChild(tdImg);

    // nombre
    const tdNombre = document.createElement('td');
    const nombreInput = document.createElement('input');
    nombreInput.type = 'text';
    nombreInput.value = p.nombre || '';
    nombreInput.oninput = e => {
      const idx = findIndexById(p.id);
      if(idx !== -1) productos[idx].nombre = e.target.value;
    };
    tdNombre.appendChild(nombreInput);
    tr.appendChild(tdNombre);

    // descripcion
    const tdDesc = document.createElement('td');
    const desc = document.createElement('textarea');
    desc.rows = 2;
    desc.value = p.descripcion || '';
    desc.oninput = e => { const idx = findIndexById(p.id); if(idx !== -1) productos[idx].descripcion = e.target.value; };
    tdDesc.appendChild(desc);
    tr.appendChild(tdDesc);

    // categoria
    const tdCat = document.createElement('td');
    const cat = document.createElement('input');
    cat.type = 'text';
    cat.value = p.categoria || '';
    cat.oninput = e => { const idx = findIndexById(p.id); if(idx !== -1) productos[idx].categoria = e.target.value; };
    tdCat.appendChild(cat);
    tr.appendChild(tdCat);

    // precio
    const tdPrecio = document.createElement('td');
    const precio = document.createElement('input');
    precio.type = 'text';
    precio.value = p.precio || '';
    precio.oninput = e => { const idx = findIndexById(p.id); if(idx !== -1) productos[idx].precio = e.target.value; };
    tdPrecio.appendChild(precio);
    tr.appendChild(tdPrecio);

    // acciones
    const tdAcc = document.createElement('td');
    tdAcc.className = 'rowActions';

    const b1 = document.createElement('button');
    b1.textContent = "Guardar";
    b1.onclick = () => guardarFilaPorId(p.id);

    const b2 = document.createElement('button');
    b2.textContent = "Editar";
    b2.style.background = "#2d87d6";
    b2.onclick = () => loadIntoFormById(p.id);

    const b3 = document.createElement('button');
    b3.textContent = "Eliminar";
    b3.className = "danger";
    b3.onclick = () => eliminarProductoPorId(p.id);

    tdAcc.appendChild(b1);
    tdAcc.appendChild(b2);
    tdAcc.appendChild(b3);

    tr.appendChild(tdAcc);
    tb.appendChild(tr);
  });
}

function findIndexById(id){ return productos.findIndex(x => x.id === id); }

/**********************************************************
 * Form helpers (ahora cargan por ID y scrollean al form)
 **********************************************************/
function toggleForm(){ const f=document.getElementById('form'); f.style.display = f.style.display === 'none' || f.style.display === '' ? 'block' : 'none'; if(f.style.display==='block') f.scrollIntoView({behavior:'smooth', block:'center'}); }
function cancelForm(){ document.getElementById('editId').value=''; document.getElementById('nombre').value=''; document.getElementById('descripcion').value=''; document.getElementById('precio').value=''; document.getElementById('imagen').value=''; document.getElementById('categoria').value=''; document.getElementById('preview').style.display='none'; document.getElementById('form').style.display='none'; }
function previewImage(){ const v=document.getElementById('imagen').value.trim(); const img=document.getElementById('preview'); if(!v){ img.style.display='none'; img.src=''; return; } img.src=v; img.style.display='block'; img.onerror=()=>{ img.style.display='none'; }; }
function loadIntoFormById(id){ const idx = findIndexById(id); if(idx === -1){ showToast('Producto no encontrado para editar','err'); return; } const p = productos[idx]; document.getElementById('editId').value = p.id; document.getElementById('nombre').value = p.nombre||''; document.getElementById('descripcion').value = p.descripcion||''; document.getElementById('precio').value = p.precio||''; document.getElementById('imagen').value = p.imagen||''; document.getElementById('categoria').value = p.categoria||''; previewImage(); const f = document.getElementById('form'); f.style.display = 'block'; f.scrollIntoView({behavior:'smooth', block:'center'}); }
function validarProductoObj(obj){ if(!obj.nombre) return "Falta nombre"; if(!obj.precio) return "Falta precio"; return null; }
function guardarFormulario(){ const nombre=document.getElementById('nombre').value.trim(); const descripcion=document.getElementById('descripcion').value.trim(); const precio=sanitizePrice(document.getElementById('precio').value.trim()); const imagen=document.getElementById('imagen').value.trim(); const categoria=document.getElementById('categoria').value.trim(); const editId=document.getElementById('editId').value; const obj={ nombre, descripcion, precio, imagen, categoria }; const err=validarProductoObj(obj); if(err){ showToast(err,'err'); return; } if(editId){ const idx = findIndexById(editId); if(idx !== -1){ productos[idx] = { ...productos[idx], ...obj }; if(!productos[idx].id || !/^prod\d{4}$/.test(productos[idx].id)) productos[idx].id = generateNextProdId(); } else { showToast('ID de edici√≥n no encontrado','err'); }
  } else { const id = generateNextProdId(); productos.push({ id, ...obj }); }
  render(productos);
  document.getElementById('form').style.display='none';
  showToast('Producto agregado/actualizado localmente','ok',1800);
}
function procesarMulti(){ const raw=document.getElementById('multiInput').value.trim(); if(!raw){ showToast('Nada para procesar','err'); return;} const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean); for(const ln of lines){ const parts=ln.split('|').map(p=>p.trim()); const nombre=parts[0]||'Sin nombre'; const descripcion=parts[1]||''; const precio=sanitizePrice(parts[2]||''); const imagen=parts[3]||''; const categoria=parts[4]||''; const id=generateNextProdId(); productos.push({ id, nombre, descripcion, precio, imagen, categoria }); } document.getElementById('multiInput').value=''; render(productos); showToast('Productos agregados localmente. Presion√° "Guardar TODOS los cambios".','info',3500); }

function eliminarProductoPorId(id){ if(!confirm('Eliminar producto?')) return; const idx = findIndexById(id); if(idx !== -1){ productos.splice(idx,1); render(productos); showToast('Producto eliminado localmente','info',1600); } else { showToast('Producto no encontrado','err'); } }

/**********************************************************
 * Refrescar array desde la tabla (importante antes de "Guardar TODOS")
 * Ahora se usa data-row-id para mapear
 **********************************************************/
function refrescarArrayDesdeTabla(){
  const filas = document.querySelectorAll("#tbody tr");
  const nuevos = [];
  filas.forEach((fila) => {
    const id = fila.dataset.rowId || generateNextProdId();
    const celdas = fila.querySelectorAll("td");
    const nombre = celdas[1].querySelector("input").value.trim();
    const descripcion = celdas[2].querySelector("textarea").value.trim();
    const categoria = celdas[3].querySelector("input").value.trim();
    const precio = sanitizePrice(celdas[4].querySelector("input").value.trim());
    const productoExistente = productos.find(p => p.id === id) || {};
    const imagen = productoExistente.imagen || '';
    nuevos.push({ id, nombre, descripcion, categoria, precio, imagen });
  });
  productos = nuevos;
}

/**********************************************************
 * GitHub helpers
 **********************************************************/
async function githubGetFileInfo(path){
  const token = getToken();
  const headers = token ? { Authorization: 'token ' + token, 'Accept': 'application/vnd.github.v3+json' } : { 'Accept': 'application/vnd.github.v3+json' };
  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`;
  const res = await fetch(url, { headers });
  if(!res.ok) {
    const txt = await res.text().catch(()=>'');
    throw new Error(`GitHub get ${path} -> ${res.status} ${txt}`);
  }
  return await res.json();
}

async function githubPutFile(path, contentString, message, sha){
  const token = getToken();
  if(!token) throw new Error('Token requerido para subir cambios a GitHub');

  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`;
  const body = { message, content: btoa(unescape(encodeURIComponent(contentString))), branch: BRANCH };
  if(sha) body.sha = sha;

  const res = await fetch(url, {
    method: 'PUT',
    headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github.v3+json' },
    body: JSON.stringify(body)
  });

  const data = await res.json().catch(()=>({}));
  if(!res.ok){
    throw new Error(`GitHub PUT ${path} -> ${res.status}: ${data.message || JSON.stringify(data)}`);
  }
  return data;
}

/**********************************************************
 * Guardar productos.json (PARCHE: pedir SHA FRESCO justo antes de PUT)
 **********************************************************/
async function saveMainJson(arr, commitMessage){
  const out = arr.map(item => ordenarCamposPorIdioma(item, 'ES'));
  const contentString = JSON.stringify(out, null, 2);

  let shaActual;
  try{ const info = await githubGetFileInfo(MAIN_JSON); shaActual = info.sha; }catch(e){ shaActual = undefined; }

  try{ const info2 = await githubGetFileInfo(MAIN_JSON); shaActual = info2.sha; }catch(e){ }

  await githubPutFile(MAIN_JSON, contentString, commitMessage, shaActual);
}

/**********************************************************
 * Sincronizar precios en EN y PT (PARCHE: pedir SHA fresco ANTES de PUT)
 **********************************************************/
async function syncPricesToLangs(){
  const token = getToken();
  if(!token){ showToast('Token requerido para sincronizar EN/PT', 'err', 4000); return; }

  const byId = {};
  productos.forEach(p => { if(p.id) byId[p.id] = p; });

  async function processLangFile(filename, idioma){
    let info;
    try{ info = await githubGetFileInfo(filename); }catch(e){ info = null; }

    let arr = [];
    if(info && info.content){
      const raw = info.content.replace(/\n/g,'');
      const decoded = decodeURIComponent(escape(window.atob(raw)));
      try{ arr = JSON.parse(decoded); if(!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
    }

    let changed = false;

    const newArr = arr.map(item => {
      const itemId = item.id || null;
      if(itemId && byId[itemId]){
        const nuevo = sanitizePrice(byId[itemId].precio);
        if('precio' in item && String(item.precio) !== nuevo){ item.precio = nuevo; changed = true; }
        if('price' in item && String(item.price) !== nuevo){ item.price = nuevo; changed = true; }
        if('preco' in item && String(item.preco) !== nuevo){ item.preco = nuevo; changed = true; }
      }
      // üîÑ sincronizar imagen por ID (ES / EN / PT)
const nuevaImagen = byId[itemId].imagen || '';

if('imagen' in item && item.imagen !== nuevaImagen){
  item.imagen = nuevaImagen;
  changed = true;
}

if('image' in item && item.image !== nuevaImagen){
  item.image = nuevaImagen;
  changed = true;
}

if('imagem' in item && item.imagem !== nuevaImagen){
  item.imagem = nuevaImagen;
  changed = true;
}

      if(!item.id && itemId) item.id = itemId;
      return ordenarCamposPorIdioma(item, idioma);
    });

    if(info === null){
      const created = [];
      for(const pid in byId){ const p = byId[pid]; if(!p) continue; const obj = ordenarCamposPorIdioma({ id: p.id, nombre: p.nombre, descripcion: p.descripcion, precio: p.precio, imagen: p.imagen, categoria: p.categoria }, idioma); created.push(obj); }
      const contentStringCreate = JSON.stringify(created, null, 2);
      await githubPutFile(filename, contentStringCreate, `Crea ${filename} desde productos.json`, undefined);
      return;
    }

    if(changed){ const latestInfo = await githubGetFileInfo(filename); const latestSha = latestInfo.sha; const contentString = JSON.stringify(newArr, null, 2); await githubPutFile(filename, contentString, `Sincroniza precios desde productos.json`, latestSha); }
  }

  await processLangFile(EN_JSON, 'EN');
  await processLangFile(PT_JSON, 'PT');
}

/**********************************************************
 * Guardar fila por ID (usa saveMainJson + syncPricesToLangs)
 **********************************************************/
async function guardarFilaPorId(id){
  try{
    const idx = findIndexById(id);
    if(idx === -1) throw new Error('Producto no encontrado');
    const p = productos[idx];
    if(!p.id || !/^prod\d{4}$/.test(p.id)) p.id = generateNextProdId();
    p.precio = sanitizePrice(p.precio);

    await saveMainJson(productos, `Actualiza producto ${p.id} - precio ${p.precio}`);
    await syncPricesToLangs();

    showToast('Producto guardado y precios sincronizados en EN/PT', 'ok', 2600);
    render(productos);
  }catch(e){ console.error(e); showToast('Error al guardar fila: ' + (e.message||e), 'err', 5000); }
}

/**********************************************************
 * Guardar TODOS - refresca tabla y usa saveMainJson parcheado
 **********************************************************/
async function guardarTodosLosPrecios(){
  try{
    // NO reconstruir productos desde la tabla
    productos = productos.map(p => ({
      ...p,
      precio: sanitizePrice(p.precio)
    }));

    await saveMainJson(productos, `Guardar TODOS los productos - sincronizando precios a EN/PT`);
    await syncPricesToLangs();

    showToast('Todos los cambios guardados y sincronizados (ES/EN/PT)', 'ok', 3000);
    render(productos);

  }catch(e){
    console.error(e);
    showToast('Error al guardar todos: ' + (e.message||e), 'err', 6000);
  }
}

/**********************************************************
 * Filtrado (no rompe indices: actions usan ids)
 **********************************************************/
function filterProducts(){
  const q = document.getElementById('search').value.toLowerCase().trim();
  if(!q){ render(productos); return; }
  const filtered = productos.filter(p =>
    (p.nombre||'').toLowerCase().includes(q) ||
    (p.descripcion||'').toLowerCase().includes(q) ||
    (p.categoria||'').toLowerCase().includes(q)
  );
  render(filtered);
}
function irWhatsApp(){
  const numero = "5491123140119"; // ‚Üê pon√© tu n√∫mero real
  const mensaje = encodeURIComponent(
    "Hola, necesito ayuda con el admin de la carta digital"
  );
  window.open(`https://wa.me/${numero}?text=${mensaje}`, "_blank");
}

/**********************************************************
 * Init
 **********************************************************/
document.addEventListener('DOMContentLoaded', () => { loadProducts(); });
</script>

</body>
</html>
</body>
</html>
}

/* ================= HEADER / LOGO ================= */
header{
  width: 100%;
  height: 220px;
  overflow: hidden;

  display: flex;
  justify-content: center;
  align-items: center;
}

header img{
  width: 100%;
  height: 100%;
  object-fit: cover;         /* o contain si quer√©s que se vea entero */
  object-position: center;   /* centra el recorte */
  display: block;
}
/* ================= BANNER ================= */

.banner {
  font-family: 'Playfair Display', serif;
  padding: 12px 18px;
  font-size: clamp(1.2rem, 2.5vw, 1.6rem);
  font-weight: 600;
  background: rgba(255,255,255,0.85);
  border-radius: 10px;
  margin: 15px auto;
  width: fit-content;
  color: #3b2314;
}

/* ================= IDIOMAS ================= */

#languageSwitcher {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 10px 0;
}

.lang-btn {
  background: #806250;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}

.lang-btn.active {
  background: #a07b68;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* ================= BUSCADOR ================= */

.search-box {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 15px;
}

.search-box input {
  padding: 10px;
  width: 60%;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.search-box button {
  background: #806250;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  cursor: pointer;
}

/* ================= CATEGOR√çAS ================= */

#category-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin: 18px 12px;
}

#category-buttons button {
  background: linear-gradient(135deg, #9a7b65, #7a5a46);
  color: #fff;
  border: none;
  border-radius: 999px; /* redonditos tipo app */
  padding: 10px 18px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.18);
  transition: all 0.25s ease;
}

#category-buttons button:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 14px rgba(0,0,0,0.25);
  background: linear-gradient(135deg, #a8866f, #6b4e3d);
}

#category-buttons button:active {
  transform: scale(0.97);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* ================= PRODUCTOS ================= */

#product-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  padding: 10px;
}

.item {
  background: rgba(255,255,255,0.95);
  border-radius: 14px;
  width: min(420px, 100%);   /* üî• se adapta */
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  overflow: hidden;
  transition: 0.2s;
}


.item img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}

.item h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.2rem;
  margin: 8px;
}

.item p {
  margin: 0 8px 10px;
}

.price {
  font-weight: bold;
  margin: 0 8px 12px;
  display: block;
}

.msg {
  padding: 20px;
  color: #a00;
}

/* ================= BOT√ìN SUBIR ================= */

#btnUp {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: #8c6954;
  color: white;
  border: none;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  display: none;
  transition: 0.3s;
}

#btnUp:hover {
  background: #6b4e3d;
  transform: scale(1.1);
}

/* ================= RESPONSIVE ================= */

@media (max-width: 900px) {
  .item {
    width: 45%;
  }
}

@media (max-width: 600px) {
  .item {
    width: 90%;
  }

  .search-box input {
    width: 90%;
  }
}

@media (max-width: 380px) {
  .item {
    width: 95%;
  }
  @media (max-width: 600px) {
  header img {
    object-position: center 30%;
  }
}
@media (max-width: 600px) {
  header img {
    height: 160px;
    max-height: 160px;
    object-position: center 30%;
  }
}
}
  </style>
</head>

<body>

  <header>
    <img src="img/logo1.png" alt="Tilo Caf√©">
  </header>

  <div class="banner" id="banner-text">¬°Bienvenidos a quispe!</div>

  <div id="languageSwitcher">
    <button id="btn-es" class="lang-btn">üá™üá∏ Espa√±ol</button>
    <button id="btn-en" class="lang-btn">üá¨üáß English</button>
    <button id="btn-pt" class="lang-btn">üáßüá∑ Portugu√™s</button>
  </div>

  <div class="search-box">
    <input id="search" type="text" placeholder="Buscar por nombre, descripci√≥n o categor√≠a...">
    <button id="btnSearch">Buscar</button>
  </div>

  <div id="category-buttons"></div>
  <div id="product-list"></div>

  <button id="btnUp">‚¨ÜÔ∏è</button>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const USER = "sequispe";
  const REPO = "carta";
  let idiomaActual = localStorage.getItem("idioma") || "es";

  const btnEs = document.getElementById("btn-es");
  const btnEn = document.getElementById("btn-en");
  const btnPt = document.getElementById("btn-pt");
  const banner = document.getElementById("banner-text");
  const categoryContainer = document.getElementById("category-buttons");
  const productList = document.getElementById("product-list");
  const searchInput = document.getElementById("search");
  const btnSearch = document.getElementById("btnSearch");
  const btnUp = document.getElementById("btnUp");

  let productos = [];

  function scrollToProducts() {
    productList.scrollIntoView({ behavior: "smooth" });
  }

  function actualizarBotones() {
    btnEs.classList.toggle("active", idiomaActual === "es");
    btnEn.classList.toggle("active", idiomaActual === "en");
    btnPt.classList.toggle("active", idiomaActual === "pt");

    if (idiomaActual === "es") banner.textContent = "¬°Bienvenidos a Tilo Caf√© Ag√ºero 2298!";
    if (idiomaActual === "en") banner.textContent = "Welcome to Tilo Caf√© Ag√ºero 2298!";
    if (idiomaActual === "pt") banner.textContent = "Bem-vindo ao Tilo Caf√© Ag√ºero 2298!";
  }

  async function load() {
    actualizarBotones();

    let filename = "productos.json";
    if (idiomaActual === "en") filename = "productos-en.json";
    if (idiomaActual === "pt") filename = "productos-port.json";

    /* üöÄ URL SIN BLOQUEO (jsDelivr) */
    const RAW_URL = `https://raw.githubusercontent.com/${USER}/${REPO}/main/${filename}`;

    try {
      const res = await fetch(RAW_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Error cargando productos");

      const data = await res.json();

      productos = data.map(p => ({
        nombre:
          idiomaActual === "es" ? (p.nombre || p.nome) :
          idiomaActual === "en" ? (p.name || p.nome) :
          p.nome,

        descripcion:
          idiomaActual === "es" ? (p.descripcion || p.descricao) :
          idiomaActual === "en" ? (p.description || p.descricao) :
          p.descricao,

        precio: p.precio || p.preco || p.price,
        imagen: p.imagen || p.imagem || p.image,

        categoria:
          idiomaActual === "es" ? p.categoria :
          idiomaActual === "en" ? (p.category || p.categoria) :
          p.categoria
      }));

      renderCategories();
      renderProducts("Todos");

    } catch (e) {
      console.error(e);
      productList.innerHTML = `<div class="msg">‚ö†Ô∏è No se pudieron cargar los productos.</div>`;
    }
  }

  function renderCategories() {
    const categorias = ["Todos", ...new Set(productos.map(p => p.categoria).filter(Boolean))];
    categoryContainer.innerHTML = "";
    categorias.forEach(cat => {
      const btn = document.createElement("button");
      btn.textContent = cat;
      btn.addEventListener("click", () => {
        renderProducts(cat);
        scrollToProducts();
      });
      categoryContainer.appendChild(btn);
    });
  }

  function renderProducts(categoria) {
    productList.innerHTML = "";
    const lista = categoria === "Todos" ? productos : productos.filter(p => p.categoria === categoria);

    if (lista.length === 0) {
      productList.innerHTML = `<div class="msg">No hay productos disponibles.</div>`;
      return;
    }

    lista.forEach(p => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <img src="${p.imagen}" alt="${p.nombre}">
        <h3>${p.nombre}</h3>
        <p>${p.descripcion || ""}</p>
        <span class="price">$${p.precio}</span>`;
      productList.appendChild(div);
    });
  }

  function buscar() {
    const q = searchInput.value.toLowerCase().trim();
    const res = productos.filter(p =>
      p.nombre.toLowerCase().includes(q) ||
      (p.descripcion || "").toLowerCase().includes(q) ||
      p.categoria.toLowerCase().includes(q)
    );

    if (res.length === 0) {
      productList.innerHTML = `<div class="msg">üîç No se encontraron resultados.</div>`;
      return;
    }

    productList.innerHTML = "";
    res.forEach(p => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <img src="${p.imagen}" alt="${p.nombre}">
        <h3>${p.nombre}</h3>
        <p>${p.descripcion || ""}</p>
        <span class="price">$${p.precio}</span>`;
      productList.appendChild(div);
    });

    scrollToProducts();
  }

  btnEs.addEventListener("click", () => { idiomaActual = "es"; localStorage.setItem("idioma", "es"); load(); });
  btnEn.addEventListener("click", () => { idiomaActual = "en"; localStorage.setItem("idioma", "en"); load(); });
  btnPt.addEventListener("click", () => { idiomaActual = "pt"; localStorage.setItem("idioma", "pt"); load(); });

  btnSearch.addEventListener("click", buscar);
  searchInput.addEventListener("keydown", e => { if (e.key === "Enter") buscar(); });

  window.addEventListener("scroll", () => {
    btnUp.style.display = window.scrollY > 300 ? "block" : "none";
  });

  btnUp.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  load();
});
</script>

</body>
</html>
