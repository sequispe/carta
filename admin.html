<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Carta â€” sequispe</title>

<style>
@media(max-width:720px){
  table,thead,tbody,tr,td,th{
    display:block;
  }
  thead{display:none}
  tr{
    margin-bottom:12px;
    border:1px solid #ddd;
    border-radius:8px;
    padding:8px;
    background:#fff;
  }
  td{
    border:none;
    padding:6px 0;
  }
  img.mini{
    max-width:80px;
  }
}
body{
  font-family:'Segoe UI',sans-serif;
  margin:0;
  padding:16px;
  background:#f7f3f0;
  color:#333;
}
h1{
  text-align:center;
  color:#806250;
  margin-bottom:12px;
}
.topRow{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
button{
  background:#806250;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}
button.secondary{background:#5c8a50}
button.danger{background:#c0392b}
input,textarea{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th{
  background:#806250;
  color:#fff;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  vertical-align:top;
}
img.mini{
  max-width:60px;
  border-radius:6px;
}
.toast{
  position:fixed;
  top:20px;
  right:20px;
  padding:12px 16px;
  border-radius:8px;
  color:#fff;
  font-weight:600;
  opacity:0;
  transform:translateY(-10px);
  transition:.3s;
}
.toast.show{opacity:1;transform:none}
.toast.ok{background:#2ecc71}
.toast.err{background:#e74c3c}
body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
h1{text-align:center;color:#806250}
.topRow{display:flex;justify-content:space-between;gap:10px;margin-bottom:12px}
input,textarea{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%}
button{background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
button.danger{background:#c0392b}
button.secondary{background:#5c8a50}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px}
th{background:#806250;color:#fff}
img.mini{max-width:60px;border-radius:6px}
.toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;color:#fff;font-weight:bold;opacity:0;transition:.3s}
.toast.show{opacity:1}
.toast.ok{background:#2ecc71}
.toast.err{background:#e74c3c}
</style>
</head>

<body>

<h1>Admin Carta â€” sequispe</h1>

<div class="topRow">
  <div>
    <b>Repositorio:</b> sequispe / carta<br>
    <input type="password" id="token" placeholder="Token GitHub (repo)">
    <button onclick="saveToken()">Guardar token</button>
  </div>
  <div>
    <input id="search" placeholder="Buscar..." oninput="filterProducts()">
  </div>
</div>

<button onclick="guardarTodos()">ðŸ’¾ Guardar TODOS</button>

<table>
<thead>
<tr>
  <th>Img</th>
  <th>Nombre</th>
  <th>DescripciÃ³n</th>
  <th>CategorÃ­a</th>
  <th>Precio</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
/* ================= CONFIG ================= */
const USERNAME = "sequispe";
const REPO = "carta";
const BRANCH = "main";
const MAIN_JSON = "productos.json";
const EN_JSON = "productos-en.json";
const PT_JSON = "productos-port.json";
const BASE_IMG="https://raw.githubusercontent.com/sequispe/carta/main/img/";


let productos = [];

/* ================= TOAST ================= */
function toast(msg, ok=true){
  const t=document.createElement("div");
  t.className="toast "+(ok?"ok":"err");
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add("show"),10);
  setTimeout(()=>{t.remove()},3000);
}

/* ================= TOKEN ================= */
function saveToken(){
  const t=document.getElementById("token").value.trim();
  if(!t) return toast("PegÃ¡ el token",false);
  localStorage.setItem("gh_token",t);
  toast("Token guardado");
}
function getToken(){ return localStorage.getItem("gh_token"); }

/* ================= GITHUB ================= */
async function githubGetFileInfo(path){
  const token=getToken();
  const res=await fetch(
    `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`,
    {headers:{Authorization:"token "+token}}
  );
  if(!res.ok) throw new Error("No existe "+path);
  return await res.json();
}

async function githubPutFile(path,content,message,sha){
  const token=getToken();
  const body={
    message,
    content:btoa(unescape(encodeURIComponent(content))),
    branch:BRANCH
  };
  if(sha) body.sha=sha;

  const res=await fetch(
    `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`,
    {
      method:"PUT",
      headers:{
        Authorization:"token "+token,
        "Content-Type":"application/json"
      },
      body:JSON.stringify(body)
    }
  );
  if(!res.ok) throw new Error("Error al guardar "+path);
}

/* ================= LOAD ================= */
async function loadProducts(){
  const r=await fetch(
    `https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}`,
    {cache:"no-store"}
  );
  if(!r.ok) return toast("No se pudo cargar productos.json",false);

  productos=await r.json();
  render(productos);
}
loadProducts();

/* ================= RENDER ================= */
function render(arr){
  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  arr.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><img class="mini" src="${p.imagen?BASE_IMG+p.imagen:""}"></td>
      <td><input value="${p.nombre||""}"></td>
      <td><textarea>${p.descripcion||""}</textarea></td>
      <td><input value="${p.categoria||""}"></td>
      <td><input value="${p.precio||""}"></td>
      <td>
        <button onclick="guardarFila('${p.id}')">Guardar</button>
        <button class="danger" onclick="eliminar('${p.id}')">X</button>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ================= ACTIONS ================= */
async function guardarFila(id){
  const info=await githubGetFileInfo(MAIN_JSON);
  await githubPutFile(
    MAIN_JSON,
    JSON.stringify(productos,null,2),
    "Actualiza producto "+id,
    info.sha
  );
  toast("Producto guardado");
}

async function guardarTodos(){
  const info=await githubGetFileInfo(MAIN_JSON);
  await githubPutFile(
    MAIN_JSON,
    JSON.stringify(productos,null,2),
    "Guardar todos",
    info.sha
  );
  toast("Todo guardado âœ”");
}

function eliminar(id){
  productos=productos.filter(p=>p.id!==id);
  render(productos);
}

/* ================= FILTER ================= */
function filterProducts(){
  const q=document.getElementById("search").value.toLowerCase();
  render(productos.filter(p=>
    (p.nombre||"").toLowerCase().includes(q) ||
    (p.descripcion||"").toLowerCase().includes(q)
  ));
}
/* ================= SINCRONIZAR EN / PT ================= */

function ordenarPorIdioma(item, lang){
  if(lang === "EN"){
    return {
      id: item.id,
      name: item.nombre,
      description: item.descripcion,
      price: item.precio,
      image: item.imagen,
      category: item.categoria
    };
  }
  if(lang === "PT"){
    return {
      nome: item.nombre,
      descricao: item.descripcion,
      preco: item.precio,
      imagem: item.imagen,
      categoria: item.categoria,
      id: item.id
    };
  }
}

async function syncLangFile(filename, lang){
  let sha = null;
  try{
    const info = await githubGetFileInfo(filename);
    sha = info.sha;
  }catch(e){}

  const arr = productos.map(p => ordenarPorIdioma(p, lang));
  const content = JSON.stringify(arr, null, 2);

  await githubPutFile(
    filename,
    content,
    "Sincroniza desde productos.json",
    sha
  );
}

async function syncAllLangs(){
  await syncLangFile(EN_JSON, "EN");
  await syncLangFile(PT_JSON, "PT");
}
async function guardarFila(id){
  const info = await githubGetFileInfo(MAIN_JSON);

  await githubPutFile(
    MAIN_JSON,
    JSON.stringify(productos, null, 2),
    "Actualiza producto " + id,
    info.sha
  );

  await syncAllLangs();
  toast("Producto sincronizado ES / EN / PT âœ”");
}

async function guardarTodos(){
  const info = await githubGetFileInfo(MAIN_JSON);

  await githubPutFile(
    MAIN_JSON,
    JSON.stringify(productos, null, 2),
    "Guardar todos (sync)",
    info.sha
  );

  await syncAllLangs();
  toast("Todo guardado y sincronizado âœ”");
}	
function saveToken(){
  const t = document.getElementById("token").value.trim();
  if(!t) return toast("PegÃ¡ el token",false);
  localStorage.setItem("gh_token", t);
  document.getElementById("token").value = "********";
  toast("Token guardado");
}

function getToken(){
  return localStorage.getItem("gh_token");
}

window.addEventListener("DOMContentLoaded", ()=>{
  if(getToken()){
    document.getElementById("token").value = "********";
  }
});
</script>

</body>
</html>
