<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Carta - Tilo Caf√© Aguero (Sincroniza precios ES/EN/PT)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
    h1{text-align:center;color:#806250;margin-bottom:10px}
    .topRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="password"], textarea{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box}
    button{background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#5c8a50}
    button.danger{background:#c0392b}
    form{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:none}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#806250;color:#fff}
    img.mini{max-width:60px;border-radius:6px}
    #guardarTodos{position:fixed;top:18px;right:18px;z-index:1200;padding:10px 14px;background:#a07b68;color:#fff;border-radius:8px}
    .small{font-size:13px;color:#666}
    .rowActions{display:flex;gap:6px}
    .previewImg{max-width:120px;margin-top:8px;border-radius:6px}
    textarea#multiInput{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
    .toast {
      position: fixed; top: 24px; right: 24px; z-index: 2000; padding: 12px 16px;
      border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      opacity: 0; transform: translateY(-10px); transition: opacity .25s ease, transform .25s ease; max-width: 360px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.ok { background: #2ecc71; }
    .toast.info { background: #3498db; }
    .toast.err { background: #e74c3c; }
    @media(max-width:720px){ .topRow{flex-direction:column;align-items:flex-start} table{font-size:13px} }
  </style>
</head>
<body>
  <h1>Admin Carta ‚Äî Tilo Caf√© Aguero</h1>
  <div class="topRow">
    <div style="flex:1">
      <div style="margin-bottom:6px"><span class="small">Repositorio:</span> <b> tilo-restocafe / cartaaguero</b></div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="min-width:40px">Token:</label>
        <input type="password" id="token" placeholder="Pegar token de GitHub (repo contents)" style="max-width:340px">
        <button onclick="saveToken()">Guardar</button>
        <button onclick="clearToken()">Borrar</button>
        <button style="background:#888;padding:6px 8px;border-radius:6px;margin-left:6px" onclick="toggleTokenVisibility()">üëÅ</button>
        <span class="small" id="tokenStatus" style="margin-left:8px">No guardado</span>
      </div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Buscar..." oninput="filterProducts()" style="min-width:180px;max-width:360px">
      <button id="toggleFormBtn" onclick="toggleForm()">+ Agregar producto</button>
      <button class="secondary" onclick="irWhatsApp()">üì≤ Ayuda por WhatsApp</button>
    </div>
  </div>

  <button id="guardarTodos" onclick="guardarTodosLosPrecios()">üíæ Guardar TODOS los cambios</button>

  <!-- Formulario simple -->
  <form id="form">
    <input type="hidden" id="editId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Nombre</label>
        <input id="nombre" type="text">
      </div>
      <div>
        <label>Precio</label>
        <input id="precio" type="text" placeholder="Ej: 3400 (sin $)">
      </div>

      <div style="grid-column:1/3">
        <label>Descripci√≥n</label>
        <textarea id="descripcion" rows="3"></textarea>
      </div>

      <div>
        <label>Imagen (ruta o URL)</label>
        <input id="imagen" type="text" oninput="previewImage()">
        <img id="preview" class="previewImg" style="display:none">
      </div>

      <div>
        <label>Categor√≠a</label>
        <input id="categoria" type="text" placeholder="Ej: Cafeter√≠a">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button type="button" onclick="guardarFormulario()">Guardar</button>
      <button type="button" onclick="cancelForm()" style="background:#999">Cancelar</button>
    </div>
  </form>

  <table aria-label="Productos">
    <thead>
      <tr><th style="width:80px">Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th style="width:100px">Precio (ES)</th><th style="width:180px">Acciones</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
// ================== CONFIG ==================
const USERNAME = "tilo-restocafe";
const REPO = "cartaaguero";
const BRANCH = "main";

const IMG_BASE_URL = "https://cdn.jsdelivr.net/gh/tilo-restocafe/cartaaguero@main/img/";

const MAIN_JSON = "productos.json";

// ================== ESTADO ==================
let productos = [];
let editIndex = null;

// ================== HELPERS ==================
function resolverImagen(ruta) {
  if (!ruta) return "";
  if (ruta.startsWith("http")) return ruta;
  ruta = ruta.replace(/^img\//, "");
  return IMG_BASE_URL + ruta;
}

// ================== ELEMENTOS ==================
const nombreInput = document.getElementById("nombre");
const precioInput = document.getElementById("precio");
const descripcionInput = document.getElementById("descripcion");
const imagenInput = document.getElementById("imagen");
const categoriaInput = document.getElementById("categoria");
const previewImagen = document.getElementById("previewImagen");
const tablaBody = document.getElementById("tabla-productos");

// ================== PREVIEW IMAGEN ==================
imagenInput.addEventListener("input", () => {
  previewImagen.src = resolverImagen(imagenInput.value.trim());
});

// ================== CARGAR JSON ==================
async function cargarProductos() {
  const url = `https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}?t=${Date.now()}`;
  const res = await fetch(url);
  productos = await res.json();
  renderTabla();
}

// ================== RENDER TABLA ==================
function renderTabla() {
  tablaBody.innerHTML = "";

  productos.forEach((p, index) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <img src="${resolverImagen(p.imagen)}" style="width:60px;border-radius:6px;">
      </td>
      <td><input value="${p.nombre}"></td>
      <td><textarea>${p.descripcion}</textarea></td>
      <td><input value="${p.categoria}"></td>
      <td><input type="number" value="${p.precio}"></td>
      <td>
        <button onclick="guardarFila(${index})">Guardar</button>
        <button onclick="editarFila(${index})">Editar</button>
        <button onclick="eliminarFila(${index})">Eliminar</button>
      </td>
    `;

    tablaBody.appendChild(tr);
  });
}

// ================== AGREGAR / EDITAR ==================
function guardarProducto() {
  const producto = {
    nombre: nombreInput.value.trim(),
    descripcion: descripcionInput.value.trim(),
    precio: Number(precioInput.value),
    categoria: categoriaInput.value.trim(),
    imagen: imagenInput.value.trim() // SOLO nombre del archivo
  };

  if (editIndex !== null) {
    productos[editIndex] = producto;
    editIndex = null;
  } else {
    productos.push(producto);
  }

  limpiarFormulario();
  renderTabla();
}

function editarFila(index) {
  const p = productos[index];
  nombreInput.value = p.nombre;
  descripcionInput.value = p.descripcion;
  precioInput.value = p.precio;
  categoriaInput.value = p.categoria;
  imagenInput.value = p.imagen;
  previewImagen.src = resolverImagen(p.imagen);
  editIndex = index;
}

function guardarFila(index) {
  const fila = tablaBody.children[index];
  const inputs = fila.querySelectorAll("input, textarea");

  productos[index] = {
    imagen: productos[index].imagen,
    nombre: inputs[0].value,
    descripcion: inputs[1].value,
    categoria: inputs[2].value,
    precio: Number(inputs[3].value)
  };

  renderTabla();
}

function eliminarFila(index) {
  if (!confirm("¬øEliminar producto?")) return;
  productos.splice(index, 1);
  renderTabla();
}

// ================== LIMPIAR ==================
function limpiarFormulario() {
  nombreInput.value = "";
  descripcionInput.value = "";
  precioInput.value = "";
  categoriaInput.value = "";
  imagenInput.value = "";
  previewImagen.src = "";
}

// ================== INIT ==================
cargarProductos();
</script>
